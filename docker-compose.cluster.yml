# ============================================================
# AiKv Docker Compose - Cluster Configuration (6 nodes)
# ============================================================
#
# This configuration deploys a 6-node AiKv cluster:
#   - 3 master nodes (aikv1, aikv2, aikv3)
#   - 3 replica nodes (aikv4, aikv5, aikv6)
#
# IMPORTANT: The Docker images are built with the 'cluster' feature
# enabled (FEATURES=cluster). This enables cluster_enabled:1 in the
# server INFO response, which is required for redis-cli --cluster create.
#
# Note: Full cluster functionality (gossip, raft) is not yet 
# implemented. This configuration prepares the infrastructure
# for future cluster features. See config/aikv-cluster.toml
# for cluster configuration status.
#
# Usage:
#   # Start cluster
#   docker-compose -f docker-compose.cluster.yml up -d
#
#   # View logs
#   docker-compose -f docker-compose.cluster.yml logs -f
#
#   # Verify cluster mode is enabled (should show cluster_enabled:1)
#   redis-cli -p 6379 INFO cluster
#
#   # Initialize cluster (after all nodes are up)
#   redis-cli --cluster create \
#     127.0.0.1:6379 127.0.0.1:6380 127.0.0.1:6381 \
#     127.0.0.1:6382 127.0.0.1:6383 127.0.0.1:6384 \
#     --cluster-replicas 1
#
#   # Check cluster status
#   redis-cli -c -p 6379 CLUSTER INFO
#
#   # Stop cluster
#   docker-compose -f docker-compose.cluster.yml down
#
#   # Stop and remove volumes
#   docker-compose -f docker-compose.cluster.yml down -v
#
# Troubleshooting:
#   If you see "Node is not configured as a cluster node":
#   - Ensure the image was built with FEATURES=cluster
#   - Run: redis-cli INFO cluster | grep cluster_enabled
#   - Should output: cluster_enabled:1
#
# ============================================================

version: '3.8'

services:
  # ------------------------------------------------------------
  # Master Node 1
  # ------------------------------------------------------------
  aikv1:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        FEATURES: cluster
    image: aikv:cluster
    container_name: aikv1
    hostname: aikv1
    command: ["--config", "/app/config/aikv.toml"]
    ports:
      - "6379:6379"
      - "16379:16379"
    volumes:
      - aikv1-data:/app/data
      - aikv1-logs:/app/logs
      # Custom configuration
      - ./config/aikv-cluster.toml:/app/config/aikv.toml:ro
    environment:
      - RUST_LOG=info
      - AIKV_NODE_ID=n1
      - AIKV_CLUSTER_PORT=16379
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "echo PING | nc -w 1 localhost 6379 | grep -q PONG"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    networks:
      - aikv-cluster
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ------------------------------------------------------------
  # Master Node 2
  # ------------------------------------------------------------
  aikv2:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        FEATURES: cluster
    image: aikv:cluster
    container_name: aikv2
    hostname: aikv2
    command: ["--config", "/app/config/aikv.toml"]
    ports:
      - "6380:6380"
      - "16380:16380"
    volumes:
      - aikv2-data:/app/data
      - aikv2-logs:/app/logs
      # Custom configuration
      - ./config/aikv-cluster.toml:/app/config/aikv.toml:ro
    environment:
      - RUST_LOG=info
      - AIKV_NODE_ID=n2
      - AIKV_CLUSTER_PORT=16380
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "echo PING | nc -w 1 localhost 6380 | grep -q PONG"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    networks:
      - aikv-cluster
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ------------------------------------------------------------
  # Master Node 3
  # ------------------------------------------------------------
  aikv3:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        FEATURES: cluster
    image: aikv:cluster
    container_name: aikv3
    hostname: aikv3
    command: ["--config", "/app/config/aikv.toml"]
    ports:
      - "6381:6381"
      - "16381:16381"
    volumes:
      - aikv3-data:/app/data
      - aikv3-logs:/app/logs
      # Custom configuration
      - ./config/aikv-cluster.toml:/app/config/aikv.toml:ro
    environment:
      - RUST_LOG=info
      - AIKV_NODE_ID=n3
      - AIKV_CLUSTER_PORT=16381
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "echo PING | nc -w 1 localhost 6381 | grep -q PONG"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    networks:
      - aikv-cluster
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ------------------------------------------------------------
  # Replica Node 4
  # ------------------------------------------------------------
  aikv4:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        FEATURES: cluster
    image: aikv:cluster
    container_name: aikv4
    hostname: aikv4
    command: ["--config", "/app/config/aikv.toml"]
    ports:
      - "6382:6382"
      - "16382:16382"
    volumes:
      - aikv4-data:/app/data
      - aikv4-logs:/app/logs
      # Custom configuration
      - ./config/aikv-cluster.toml:/app/config/aikv.toml:ro
    environment:
      - RUST_LOG=info
      - AIKV_NODE_ID=n4
      - AIKV_CLUSTER_PORT=16382
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "echo PING | nc -w 1 localhost 6382 | grep -q PONG"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    networks:
      - aikv-cluster
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ------------------------------------------------------------
  # Replica Node 5
  # ------------------------------------------------------------
  aikv5:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        FEATURES: cluster
    image: aikv:cluster
    container_name: aikv5
    hostname: aikv5
    command: ["--config", "/app/config/aikv.toml"]
    ports:
      - "6383:6383"
      - "16383:16383"
    volumes:
      - aikv5-data:/app/data
      - aikv5-logs:/app/logs
      # Custom configuration
      - ./config/aikv-cluster.toml:/app/config/aikv.toml:ro
    environment:
      - RUST_LOG=info
      - AIKV_NODE_ID=n5
      - AIKV_CLUSTER_PORT=16383
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "echo PING | nc -w 1 localhost 6383 | grep -q PONG"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    networks:
      - aikv-cluster
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ------------------------------------------------------------
  # Replica Node 6
  # ------------------------------------------------------------
  aikv6:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        FEATURES: cluster
    image: aikv:cluster
    container_name: aikv6
    hostname: aikv6
    command: ["--config", "/app/config/aikv.toml"]
    ports:
      - "6384:6384"
      - "16384:16384"
    volumes:
      - aikv6-data:/app/data
      - aikv6-logs:/app/logs
      # Custom configuration
      - ./config/aikv-cluster.toml:/app/config/aikv.toml:ro
    environment:
      - RUST_LOG=info
      - AIKV_NODE_ID=n6
      - AIKV_CLUSTER_PORT=16384
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "echo PING | nc -w 1 localhost 6384 | grep -q PONG"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    networks:
      - aikv-cluster
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ------------------------------------------------------------
  # Redis CLI for cluster management (optional)
  # ------------------------------------------------------------
  redis-cli:
    image: redis:7-alpine
    container_name: aikv-redis-cli
    depends_on:
      aikv1:
        condition: service_healthy
      aikv2:
        condition: service_healthy
      aikv3:
        condition: service_healthy
      aikv4:
        condition: service_healthy
      aikv5:
        condition: service_healthy
      aikv6:
        condition: service_healthy
    entrypoint: ["sh"]
    stdin_open: true
    tty: true
    networks:
      - aikv-cluster
    profiles:
      - tools

# Named volumes for data persistence
volumes:
  aikv1-data:
    driver: local
  aikv1-logs:
    driver: local
  aikv2-data:
    driver: local
  aikv2-logs:
    driver: local
  aikv3-data:
    driver: local
  aikv3-logs:
    driver: local
  aikv4-data:
    driver: local
  aikv4-logs:
    driver: local
  aikv5-data:
    driver: local
  aikv5-logs:
    driver: local
  aikv6-data:
    driver: local
  aikv6-logs:
    driver: local

# Network configuration
networks:
  aikv-cluster:
    name: aikv-cluster-network
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16
